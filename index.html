<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi Wajah (Face API JS)</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    video, canvas { border: 2px solid #333; border-radius: 8px; }
    #log { margin-top: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #999; padding: 5px; text-align: center; }
    button { margin: 5px; padding: 8px 12px; border: none; background: #4CAF50; color: white; border-radius: 5px; cursor: pointer; }
    button:hover { background: #45a049; }
  </style>
</head>
<body>
  <h1>ðŸ“¸ Absensi Wajah</h1>
  <p>Demo absensi berbasis wajah di browser (face-api.js)</p>

  <video id="video" width="480" height="360" autoplay muted></video>
  <canvas id="overlay" width="480" height="360"></canvas>
  <br>
  <button id="ambilAbsensi">Ambil Absensi</button>
  <button id="downloadCSV">Download CSV</button>

  <div id="log">
    <h2>ðŸ“‘ Riwayat Absensi</h2>
    <table>
      <thead><tr><th>Waktu</th><th>Nama</th><th>Confidence</th></tr></thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("overlay");
const context = canvas.getContext("2d");
const logBody = document.getElementById("logBody");
const absensiData = []; // simpan ke array

// Contoh dataset wajah (foto referensi harus online / path relatif)
const dataset = [
  { name: "Andi", img: "https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/examples/images/bbt1.jpg" },
  { name: "Siti", img: "https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/examples/images/bbt2.jpg" }
];

let labeledFaceDescriptors;
let faceMatcher;

async function loadModels() {
  await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");
  await faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");
  await faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");
  console.log("Model siap.");
}

async function loadDataset() {
  const labeledDescriptors = [];
  for (const person of dataset) {
    const img = await faceapi.fetchImage(person.img);
    const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
    if (!detection) continue;
    labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(person.name, [detection.descriptor]));
  }
  labeledFaceDescriptors = labeledDescriptors;
  faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6);
  console.log("Dataset siap.");
}

async function startVideo() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
  video.srcObject = stream;
}

video.addEventListener("play", () => {
  const displaySize = { width: video.width, height: video.height };
  faceapi.matchDimensions(canvas, displaySize);
  setInterval(async () => {
    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
    const resizedDetections = faceapi.resizeResults(detections, displaySize);
    context.clearRect(0, 0, canvas.width, canvas.height);
    if (detections.length > 0) {
      const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
      results.forEach((result, i) => {
        const box = resizedDetections[i].detection.box;
        const drawBox = new faceapi.draw.DrawBox(box, { label: result.toString() });
        drawBox.draw(canvas);
      });
    }
  }, 500);
});

document.getElementById("ambilAbsensi").addEventListener("click", async () => {
  const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
  if (detections.length === 0) {
    alert("âŒ Tidak ada wajah terdeteksi!");
    return;
  }
  const results = detections.map(d => faceMatcher.findBestMatch(d.descriptor));
  results.forEach(r => {
    const nama = r.label !== "unknown" ? r.label : "Tidak dikenal";
    const waktu = new Date().toLocaleString();
    const conf = r.distance.toFixed(2);
    absensiData.push({ waktu, nama, conf });
    const row = `<tr><td>${waktu}</td><td>${nama}</td><td>${conf}</td></tr>`;
    logBody.innerHTML = row + logBody.innerHTML;
  });
});

document.getElementById("downloadCSV").addEventListener("click", () => {
  let csv = "Waktu,Nama,Confidence\n";
  absensiData.forEach(r => {
    csv += `${r.waktu},${r.nama},${r.conf}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.setAttribute("href", url);
  a.setAttribute("download", "absensi.csv");
  a.click();
});

(async () => {
  await loadModels();
  await loadDataset();
  await startVideo();
})();
</script>
</body>
</html>
